<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tic Tac Toe ‚Äì Level 2</title>

<!-- ‚úÖ MONETAG SDK (REQUIRED) -->
<script src='//libtl.com/sdk.js' data-zone='10394796' data-sdk='show_10394796'></script>

<style>
body{text-align:center;font-family:Arial;margin:0;padding:0;background:#f0f0f0}
#bar{background:#ffeb3b;padding:10px;font-weight:bold;}
#ann{background:pink;margin:10px;padding:8px;font-weight:bold;}
#lvl{background:lightgreen;margin:10px;padding:8px;font-weight:bold;}
#board{display:grid;grid-template-columns:repeat(3,100px);gap:6px;justify-content:center;margin-top:20px}
.cell{width:100px;height:100px;font-size:40px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;border:1px solid #333}
#ad{margin-top:20px;background:orange;padding:12px;cursor:pointer;font-weight:bold;width:180px;margin-left:auto;margin-right:auto;border-radius:6px}
</style>
</head>
<body>

<div id="bar">Coins: 0</div>
<div id="ann"></div>
<div id="lvl"></div>
<div id="board"></div>
<div id="ad">üé¨ Watch Ad</div>

<script>
/* ================= CONFIG ================= */
const API="https://telegram-bot-backend-admin-production.up.railway.app/api.php";

/* ================= UID FROM TELEGRAM BOT ================= */
const params = new URLSearchParams(window.location.search);
const UID = params.get("uid");

if (!UID) {
    alert("‚ùå Invalid access. Open this game from Telegram bot only.");
    throw new Error("UID missing");
}

console.log("Telegram UID:", UID);

/* ================= GAME STATE ================= */
let boardState = ["","","","","","","","",""];
let gameOver = false;

/* ================= LOAD USER + LEVEL 2 ================= */
async function load() {
    try {
        const u = await (await fetch(`${API}?get=user&uid=${UID}`)).json();
        document.getElementById("bar").innerText = "Coins: " + u.coins;

        const l = await (await fetch(`${API}?get=level2`)).json();
        if(l.active){
            document.getElementById("lvl").innerText =
                `Prize Pool ‚Çπ${l.prize_pool} | Level-2 Active`;
            document.getElementById("ann").innerText = l.announcement || "";
        } else {
            document.getElementById("lvl").innerText = "";
            document.getElementById("ann").innerText = "";
        }
    } catch(e) { console.log(e); }
}
load();

/* ================= DRAW BOARD ================= */
function drawBoard() {
    const bd = document.getElementById("board");
    bd.innerHTML = "";
    boardState.forEach((v,i)=>{
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.innerText = v;
        cell.onclick = ()=>play(i);
        bd.appendChild(cell);
    });
}
drawBoard();

/* ================= PLAYER MOVE ================= */
async function play(i){
    if(boardState[i] || gameOver) return;

    boardState[i] = "X";
    drawBoard();

    if(checkWin("X")){
        gameOver = true;

        // ‚úÖ Reset board immediately
        setTimeout(() => {
            boardState = ["","","","","","","","",""];
            gameOver = false;
            drawBoard();
        }, 500);

        // ‚úÖ Coins add in background
        fetch(`${API}?action=win`, {
            method:"POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ uid: UID, amount: 10 })
        }).then(() => load());

        alert("You won +10 coins!");
        return;
    }

    botMove();
}

/* ================= BOT MOVE ================= */
function botMove() {
    const empty = boardState.map((v,i)=>v===""?i:null).filter(v=>v!==null);
    if(!empty.length) return;

    boardState[empty[Math.floor(Math.random()*empty.length)]] = "O";
    drawBoard();

    if(checkWin("O")){
        gameOver = true;

        setTimeout(() => {
            boardState = ["","","","","","","","",""];
            gameOver = false;
            drawBoard();
        }, 500);

        alert("Computer wins!");
    }
}

/* ================= CHECK WIN ================= */
function checkWin(p){
    return [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
    ].some(a=>a.every(i=>boardState[i]===p));
}

/* ================= MONETAG REWARDED INTERSTITIAL ================= */
const adBtn = document.getElementById("ad");
adBtn.addEventListener("click", async () => {
    if (typeof show_10394796 !== "function") {
        alert("Ad SDK not loaded yet");
        return;
    }

    await show_10394796();

    const r = await fetch(`${API}?action=ad`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ uid: UID })
    });
    const d = await r.json();

    if(d.status === "wait"){
        alert("‚è≥ Wait 20 min before next ad");
    } else {
        alert("‚úÖ Ad watched! Coins unlocked.");
        await load();
    }
});
</script>

</body>
</html>
