<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tic Tac Toe ‚Äì Level 2</title>

<!-- ‚úÖ MONETAG SDK (DO NOT TOUCH) -->
<script src='//libtl.com/sdk.js' data-zone='10394796' data-sdk='show_10394796'></script>

<style>
body{text-align:center;font-family:Arial;margin:0;padding:0;background:#f0f0f0}
#bar{background:#ffeb3b;padding:10px;font-weight:bold;}
#ann{background:pink;margin:10px;padding:8px;font-weight:bold;}
#lvl{background:lightgreen;margin:10px;padding:8px;font-weight:bold;}
#timer{background:#ddd;margin:10px;padding:8px;font-weight:bold;}
#board{display:grid;grid-template-columns:repeat(3,100px);gap:6px;justify-content:center;margin-top:20px;opacity:0.5;pointer-events:none}
.cell{width:100px;height:100px;font-size:40px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;border:1px solid #333}
#ad{margin-top:20px;background:orange;padding:12px;cursor:pointer;font-weight:bold;width:180px;margin-left:auto;margin-right:auto;border-radius:6px}
</style>
</head>
<body>

<div id="bar">Coins: 0</div>
<div id="ann"></div>
<div id="lvl">Loading level...</div>
<div id="timer"></div>
<div id="board"></div>
<div id="ad">üé¨ Watch Ad</div>

<script>
const API = "https://telegram-bot-backend-admin-new-production.up.railway.app/api.php";

const params = new URLSearchParams(window.location.search);
const UID = params.get("uid");
if (!UID) { alert("‚ùå Open from Telegram bot only"); throw new Error("UID missing"); }

let boardState = ["","","","","","","","",""];
let gameOver = false;
let levelActive = false;
let levelLoaded = false;

function enableBoard(enable){
    const b = document.getElementById("board");
    b.style.opacity = enable ? "1" : "0.5";
    b.style.pointerEvents = enable ? "auto" : "none";
}

async function load(){
    enableBoard(false);

    const u = await fetch(`${API}?get=user&uid=${UID}`).then(r=>r.json());
    document.getElementById("bar").innerText = "Coins: " + u.coins;

    const l = await fetch(`${API}?get=level2`).then(r=>r.json());

    levelLoaded = true;

    if(l.active === true){
        levelActive = true;
        document.getElementById("lvl").innerText = `Prize Pool ‚Çπ${l.prize_pool} | Level-2 Active`;
        document.getElementById("ann").innerText = l.announcement || "";
        document.getElementById("timer").innerText =
            "Time left: " + Math.floor(l.remaining/3600) + "h " +
            Math.floor((l.remaining%3600)/60) + "m";
        enableBoard(true);
    } else {
        levelActive = false;
        document.getElementById("lvl").innerText = "Level-2 Inactive";
        document.getElementById("ann").innerText = "";
        document.getElementById("timer").innerText = "";
        enableBoard(false);
    }
}

function drawBoard(){
    const bd = document.getElementById("board");
    bd.innerHTML="";
    boardState.forEach((v,i)=>{
        const cell=document.createElement("div");
        cell.className="cell";
        cell.innerText=v;
        cell.onclick=()=>play(i);
        bd.appendChild(cell);
    });
}
drawBoard();
load();

async function play(i){
    if(!levelLoaded) return;
    if(!levelActive){ alert("Level-2 not active"); return; }
    if(boardState[i] || gameOver) return;

    boardState[i]="X";
    drawBoard();

    if(checkWin("X")){
        gameOver=true;
        const r = await fetch(`${API}?action=win&uid=${UID}`,{method:"POST"});
        const d = await r.json();
        if(d.status==="ok"){ alert("üéâ You won +10 coins"); load(); }
        setTimeout(resetBoard,800);
        return;
    }
    botMove();
}

function botMove(){
    const empty=boardState.map((v,i)=>v===""?i:null).filter(v=>v!==null);
    if(!empty.length) return;
    boardState[empty[Math.floor(Math.random()*empty.length)]]="O";
    drawBoard();
    if(checkWin("O")){
        gameOver=true;
        alert("üò¢ Computer wins");
        setTimeout(resetBoard,800);
    }
}

function resetBoard(){
    boardState=["","","","","","","","",""];
    gameOver=false;
    drawBoard();
}

function checkWin(p){
    return [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]
        .some(a=>a.every(i=>boardState[i]===p));
}

/* ================= MONETAG AD (DO NOT TOUCH) ================= */
document.getElementById("ad").onclick = async ()=>{
    if(typeof show_10394796!=="function"){ alert("Ad not ready"); return; }
    await show_10394796();
    const r = await fetch(`${API}?action=reward_ad&uid=${UID}`,{method:"POST"});
    const d = await r.json();
    if(d.status==="wait") alert("‚è≥ Wait 20 minutes");
    else if(d.status==="error") alert(d.message);
    else { alert("‚úÖ Reward added"); load(); }
};
</script>

</body>
</html>
